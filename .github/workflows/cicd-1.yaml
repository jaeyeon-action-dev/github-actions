name : cicd-1
on:
  pull_request:
    types: [opened, synchronize, closed]
    branches: [dev]
    paths:
      - 'my-app/**'

jobs:
  test:
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4
  
  image-build:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4

  deploy:
    needs: [image-build]
    runs-on: ubuntu-latest
    steps:
      - name: checkout
        uses: actions/checkout@v4



# - 가정
#     - 개발 환경에만 배포하는 CICD 구성
# - branch
#     - dev : 개발 환경
# - 요구사항
#     1. 특정 path에 대해서만 실행 (my-app)
#     2. dev branch로 PR이 생성&동기화 될 때 테스트 작업 실행 (CI)
#     3. PR이 dev branch로 머지되면, 이미지 빌드하고 개발 환경에 배포 (CD)
#     4. 배포 성공 여부 슬랙으로 전송

# ✅ 1. 전체 전략 개요
# 이미지는 **“Dev 브랜치를 중심으로 Feature 브랜치를 만들어 개발 → PR로 Dev에 병합 → Dev에 머지되면 자동으로 CI/CD로 Dev 환경 배포”**라는 흐름을 보여줍니다.
# 이는 아래와 같은 개발 전략을 포괄합니다.
# 🔹 Git Flow 중 단순화된 Feature Branch Workflow
# 항상 Dev 브랜치가 개발의 중심
# 새로운 기능은 feature/xxx 형태의 브랜치를 생성해 진행
# 기능 개발이 끝나면 Pull Request(PR) 생성 → 코드 리뷰 → Dev로 병합(Merge)
# 🔹 GitHub Actions 기반 CI(Continuous Integration)
# Feature 브랜치에 커밋할 때마다 CI가 자동 실행
# 코드 빌드
# 테스트
# 린팅/포맷팅 체크
# 의존성 검사
# PR 생성 시에도 CI 실행
# → 병합 전 문제를 차단하는 역할
# 🔹 Dev 브랜치에 Merge되었을 때 CD(Continuous Deployment)
# Dev에 PR이 merge되면
# 자동으로 Dev 환경(개발 서버)에 배포
# → QA 또는 개발자가 Dev 환경에서 바로 검증 가능
# ✅ 2. 이미지 구성 요소별 상세 분석
# 🎯 (1) Dev branch
# 메인 개발 라인
# 모든 기능은 이 브랜치를 기준으로
# 별도의 feature 브랜치를 생성해서 작업
# CI/CD 파이프라인의 핵심 기준이 되는 브랜치
# 🎯 (2) Feature branch
# 기능 개발을 위한 임시 브랜치
# 일반적으로 feature/login, feature/cart, feature/order-api 등으로 생성
# 여러 커밋이 들어오며
# → 그때마다 CI 파이프라인이 실행됨
# 💡 Feature 브랜치를 만드는 이유
# Dev 브랜치는 항상 “안정적인 상태” 유지
# 한 기능에 문제가 생겨도 전체 영향을 최소화
# 🎯 (3) Commit (보라색 동그라미)
# Feature 브랜치에서 커밋이 발생할 때
# → GitHub Actions가 자동으로 CI 실행
# 이때 하는 작업:
# build
# unit test
# static analysis
# lint/format check
# → 사전 검증(Pre-validation)
# 🎯 (4) Continuous Integration (CI, 하늘색 아이콘)
# Feature branch에서 커밋할 때마다, PR 생성할 때마다 CI 수행.
# CI의 목적은 병합되기 전 문제가 없는지 즉시 검증하는 것.
# 주요 단계
# 의존성 설치
# 코드 빌드
# 단위 테스트 자동 실행
# 코드 품질 검사(Linter)
# 보안 취약점 스캔(optional)
# CI 이유
# 초기 단계에서 오류를 발견해 비용, 위험을 크게 줄임
# 팀 협업 시 “동시에 수정한 코드 충돌” 및 “테스트 실패 코드 병합” 방지
# 🎯 (5) Pull Request(PR) (노란 다이아몬드)
# Feature 브랜치에서 개발 완료 → Dev 브랜치로 병합 요청
# PR을 통해:
# 코드 리뷰(Code Review)
# 리뷰어 승인
# 자동화 테스트(CI) 체크 통과 여부 확인
# PR == "이 기능 merge해도 안전합니다!"를 증명하는 절차.
# 🎯 (6) Merge → Dev branch
# PR 리뷰 및 CI 통과 후 dev 브랜치로 merge.
# 머지와 동시에 다음 단계 시작:
# 🎯 (7) Deploy dev (노란 박스)
# Dev 브랜치에서 merge가 일어나면 자동으로 Dev 환경에 배포(CD)
# 즉, 다음과 같은 흐름:
# PR merge
# GitHub Actions의 CD workflow 실행
# 빌드 → 아티팩트 생성 → Dev 환경 배포
# Dev 서버에서 새 기능 테스트 가능
# 이 시나리오의 의미
# QA, 개발자는 Dev 환경에서 바로 최신 기능 테스트 가능
# 개발이 빠르고 안정적으로 순환
# 운영/배포 과정 자동화를 통해 “사람이 하는 실수” 제거

# 📌 3. 전체 흐름 정리 (한눈에 보기)
# Feature branch 생성
#         ↓
#     Commit(여러 번)
#         ↓ (trigger)
#         CI (빌드/테스트)
#         ↓
# Pull Request 보내기
#         ↓ (trigger)
#         CI 재검증
#         ↓
# 리뷰어 승인 → Merge
#         ↓ (trigger)
# Dev 브랜치 반영
#         ↓
# CD → Dev 환경 자동 배포

# 🎯 4. 이 전략의 장점
# ✔ 1) 안정적인 메인 개발 라인 유지
# Dev는 항상 "문제 없는 상태"로 유지됨.
# ✔ 2) CI로 품질 자동 보증
# 사람이 발견하기 전에 테스트에서 걸러짐.
# ✔ 3) PR 기반 코드 리뷰로 품질 증가
# 코드 품질, 보안, 구조 개선에 도움.
# ✔ 4) Dev 환경 자동 배포로 개발속도 증가
# 병합 → Dev 배포 → QA 테스트
# 전체 주기가 매우 짧아짐.
# ✔ 5) 협업 표준화
# 팀원 누구나 동일한 개발-배포 프로세스를 따르게 됨.
# 📌 5. 최종 요약
# 이 이미지는 아래 3가지 전략을 결합한 표준 DevOps 개발 프로세스를 표현함:

# 💡 1) Git 전략
# Feature Branch Workflow
# PR 기반 Merge 방식
# 💡 2) CI 전략
# 커밋/PR 시 자동 빌드·테스트 실행
# 문제를 사전에 차단
# 💡 3) CD 전략
# Dev 브랜치에 merge되는 순간
# 자동으로 Dev 서버에 배포
# 즉, “Github Actions 기반으로 CICD 시작하기”의 가장 이상적인 기본 시나리오입니다.

# ### 워크플로우 구성

# - 트리거 구성
#     - github event : pull request
#     - path filter : my-app
#     - branch filter : dev
#     - 개발 환경으로 사용하는 dev branch 에만
#     - my-app이라는 디렉토리가 변경될 때
#     - PR이 생성 & 동기화 (CI), 머지되면 (CD)
# - 잡 구성
#     - test
#         - cache action 사용
#         - npm build
#     - image-build
#         - aws action
#         - aws ecr action
#         - docker
#     - deploy
#         - aws action
#         - kubectl action
#         - helm action
#         - slack action