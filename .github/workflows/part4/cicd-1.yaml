name : cicd-1
on:
  pull_request:
    types: [opened, synchronize, closed]
    branches: [dev]
    paths:
      - 'my-app/**'

jobs:
  test:
    if: github.event.action == 'opened' || github.event.action == 'synchronize'
    runs-on: ubuntu-latest
    steps:
      - name: checkout the code
        uses: actions/checkout@v4
      - name: setup node
        uses: actions/setup-node@v3
        with:
          node-version: 18
      - name: Cache Node.js modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key:  ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      - name: Install dependencies
        run: |
            cd my-app
            npm ci
      - name: npm build
        run: |
            cd my-app
            npm run build
  
  image-build:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: checkout the code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        id: credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2
        with:
          mask-password: 'true'
      - name: docker build and push
        run: |
          docker build -f Dockerfile --tag ${{secrets.REGISRY}}/${{vars.REPOSITORY}}:${{github.sha}} .
          docker push ${{secrets.REGISRY}}/${{vars.REPOSITORY}}:${{github.sha}}

  deploy:
    needs: [image-build]
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - name: checkout the code
        uses: actions/checkout@v4
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ vars.AWS_REGION }}
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
      - name: setup kubectl
        uses: azure/setup-kubectl@v3
        with:
          version: latest
      - name: setup helm
        uses: azure/setup-helm@v3
        with:
          version: latest
      - name: access kubernetes
        run: |
          aws eks update-kubeconfig --name ${{ vars.CLUSTER_NAME }}
      - name: deploy
        id: status
        run: |
          helm upgrade --install my-app kubernetes/my-app --create-namespace --namespace my-app-${{vars.SUFFIX}} \
          -- set image.tag=${{github.sha}} \
          -- set image.repository=${{secrets.REGISRY}}/${{vars.REPOSITORY}}
      - name: notify
        if: always()
        uses: slackapi/slack-github-action@v1.24.0
        with:
          payloads: |
            {
              "text": "message",
              "blocks": [
                  "type": "section",
                  "text": {
                      "type": "mrkdwn",
                      "text": "Environment: dev, Deploy Result : ${{steps.status.outcome}}, Repository : ${{github.repository}}"
                  }
                ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_WEBHOOK_TYPE: INCOMING_WEBHOOK

      



# - ê°€ì •
#     - ê°œë°œ í™˜ê²½ì—ë§Œ ë°°í¬í•˜ëŠ” CICD êµ¬ì„±
# - branch
#     - dev : ê°œë°œ í™˜ê²½
# - ìš”êµ¬ì‚¬í•­
#     1. íŠ¹ì • pathì— ëŒ€í•´ì„œë§Œ ì‹¤í–‰ (my-app)
#     2. dev branchë¡œ PRì´ ìƒì„±&ë™ê¸°í™” ë  ë•Œ í…ŒìŠ¤íŠ¸ ì‘ì—… ì‹¤í–‰ (CI)
#     3. PRì´ dev branchë¡œ ë¨¸ì§€ë˜ë©´, ì´ë¯¸ì§€ ë¹Œë“œí•˜ê³  ê°œë°œ í™˜ê²½ì— ë°°í¬ (CD)
#     4. ë°°í¬ ì„±ê³µ ì—¬ë¶€ ìŠ¬ë™ìœ¼ë¡œ ì „ì†¡

# âœ… 1. ì „ì²´ ì „ëµ ê°œìš”
# ì´ë¯¸ì§€ëŠ” **â€œDev ë¸Œëœì¹˜ë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ Feature ë¸Œëœì¹˜ë¥¼ ë§Œë“¤ì–´ ê°œë°œ â†’ PRë¡œ Devì— ë³‘í•© â†’ Devì— ë¨¸ì§€ë˜ë©´ ìë™ìœ¼ë¡œ CI/CDë¡œ Dev í™˜ê²½ ë°°í¬â€**ë¼ëŠ” íë¦„ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
# ì´ëŠ” ì•„ë˜ì™€ ê°™ì€ ê°œë°œ ì „ëµì„ í¬ê´„í•©ë‹ˆë‹¤.
# ğŸ”¹ Git Flow ì¤‘ ë‹¨ìˆœí™”ëœ Feature Branch Workflow
# í•­ìƒ Dev ë¸Œëœì¹˜ê°€ ê°œë°œì˜ ì¤‘ì‹¬
# ìƒˆë¡œìš´ ê¸°ëŠ¥ì€ feature/xxx í˜•íƒœì˜ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•´ ì§„í–‰
# ê¸°ëŠ¥ ê°œë°œì´ ëë‚˜ë©´ Pull Request(PR) ìƒì„± â†’ ì½”ë“œ ë¦¬ë·° â†’ Devë¡œ ë³‘í•©(Merge)
# ğŸ”¹ GitHub Actions ê¸°ë°˜ CI(Continuous Integration)
# Feature ë¸Œëœì¹˜ì— ì»¤ë°‹í•  ë•Œë§ˆë‹¤ CIê°€ ìë™ ì‹¤í–‰
# ì½”ë“œ ë¹Œë“œ
# í…ŒìŠ¤íŠ¸
# ë¦°íŒ…/í¬ë§·íŒ… ì²´í¬
# ì˜ì¡´ì„± ê²€ì‚¬
# PR ìƒì„± ì‹œì—ë„ CI ì‹¤í–‰
# â†’ ë³‘í•© ì „ ë¬¸ì œë¥¼ ì°¨ë‹¨í•˜ëŠ” ì—­í• 
# ğŸ”¹ Dev ë¸Œëœì¹˜ì— Mergeë˜ì—ˆì„ ë•Œ CD(Continuous Deployment)
# Devì— PRì´ mergeë˜ë©´
# ìë™ìœ¼ë¡œ Dev í™˜ê²½(ê°œë°œ ì„œë²„)ì— ë°°í¬
# â†’ QA ë˜ëŠ” ê°œë°œìê°€ Dev í™˜ê²½ì—ì„œ ë°”ë¡œ ê²€ì¦ ê°€ëŠ¥
# âœ… 2. ì´ë¯¸ì§€ êµ¬ì„± ìš”ì†Œë³„ ìƒì„¸ ë¶„ì„
# ğŸ¯ (1) Dev branch
# ë©”ì¸ ê°œë°œ ë¼ì¸
# ëª¨ë“  ê¸°ëŠ¥ì€ ì´ ë¸Œëœì¹˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ
# ë³„ë„ì˜ feature ë¸Œëœì¹˜ë¥¼ ìƒì„±í•´ì„œ ì‘ì—…
# CI/CD íŒŒì´í”„ë¼ì¸ì˜ í•µì‹¬ ê¸°ì¤€ì´ ë˜ëŠ” ë¸Œëœì¹˜
# ğŸ¯ (2) Feature branch
# ê¸°ëŠ¥ ê°œë°œì„ ìœ„í•œ ì„ì‹œ ë¸Œëœì¹˜
# ì¼ë°˜ì ìœ¼ë¡œ feature/login, feature/cart, feature/order-api ë“±ìœ¼ë¡œ ìƒì„±
# ì—¬ëŸ¬ ì»¤ë°‹ì´ ë“¤ì–´ì˜¤ë©°
# â†’ ê·¸ë•Œë§ˆë‹¤ CI íŒŒì´í”„ë¼ì¸ì´ ì‹¤í–‰ë¨
# ğŸ’¡ Feature ë¸Œëœì¹˜ë¥¼ ë§Œë“œëŠ” ì´ìœ 
# Dev ë¸Œëœì¹˜ëŠ” í•­ìƒ â€œì•ˆì •ì ì¸ ìƒíƒœâ€ ìœ ì§€
# í•œ ê¸°ëŠ¥ì— ë¬¸ì œê°€ ìƒê²¨ë„ ì „ì²´ ì˜í–¥ì„ ìµœì†Œí™”
# ğŸ¯ (3) Commit (ë³´ë¼ìƒ‰ ë™ê·¸ë¼ë¯¸)
# Feature ë¸Œëœì¹˜ì—ì„œ ì»¤ë°‹ì´ ë°œìƒí•  ë•Œ
# â†’ GitHub Actionsê°€ ìë™ìœ¼ë¡œ CI ì‹¤í–‰
# ì´ë•Œ í•˜ëŠ” ì‘ì—…:
# build
# unit test
# static analysis
# lint/format check
# â†’ ì‚¬ì „ ê²€ì¦(Pre-validation)
# ğŸ¯ (4) Continuous Integration (CI, í•˜ëŠ˜ìƒ‰ ì•„ì´ì½˜)
# Feature branchì—ì„œ ì»¤ë°‹í•  ë•Œë§ˆë‹¤, PR ìƒì„±í•  ë•Œë§ˆë‹¤ CI ìˆ˜í–‰.
# CIì˜ ëª©ì ì€ ë³‘í•©ë˜ê¸° ì „ ë¬¸ì œê°€ ì—†ëŠ”ì§€ ì¦‰ì‹œ ê²€ì¦í•˜ëŠ” ê²ƒ.
# ì£¼ìš” ë‹¨ê³„
# ì˜ì¡´ì„± ì„¤ì¹˜
# ì½”ë“œ ë¹Œë“œ
# ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ìë™ ì‹¤í–‰
# ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬(Linter)
# ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”(optional)
# CI ì´ìœ 
# ì´ˆê¸° ë‹¨ê³„ì—ì„œ ì˜¤ë¥˜ë¥¼ ë°œê²¬í•´ ë¹„ìš©, ìœ„í—˜ì„ í¬ê²Œ ì¤„ì„
# íŒ€ í˜‘ì—… ì‹œ â€œë™ì‹œì— ìˆ˜ì •í•œ ì½”ë“œ ì¶©ëŒâ€ ë° â€œí…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì½”ë“œ ë³‘í•©â€ ë°©ì§€
# ğŸ¯ (5) Pull Request(PR) (ë…¸ë€ ë‹¤ì´ì•„ëª¬ë“œ)
# Feature ë¸Œëœì¹˜ì—ì„œ ê°œë°œ ì™„ë£Œ â†’ Dev ë¸Œëœì¹˜ë¡œ ë³‘í•© ìš”ì²­
# PRì„ í†µí•´:
# ì½”ë“œ ë¦¬ë·°(Code Review)
# ë¦¬ë·°ì–´ ìŠ¹ì¸
# ìë™í™” í…ŒìŠ¤íŠ¸(CI) ì²´í¬ í†µê³¼ ì—¬ë¶€ í™•ì¸
# PR == "ì´ ê¸°ëŠ¥ mergeí•´ë„ ì•ˆì „í•©ë‹ˆë‹¤!"ë¥¼ ì¦ëª…í•˜ëŠ” ì ˆì°¨.
# ğŸ¯ (6) Merge â†’ Dev branch
# PR ë¦¬ë·° ë° CI í†µê³¼ í›„ dev ë¸Œëœì¹˜ë¡œ merge.
# ë¨¸ì§€ì™€ ë™ì‹œì— ë‹¤ìŒ ë‹¨ê³„ ì‹œì‘:
# ğŸ¯ (7) Deploy dev (ë…¸ë€ ë°•ìŠ¤)
# Dev ë¸Œëœì¹˜ì—ì„œ mergeê°€ ì¼ì–´ë‚˜ë©´ ìë™ìœ¼ë¡œ Dev í™˜ê²½ì— ë°°í¬(CD)
# ì¦‰, ë‹¤ìŒê³¼ ê°™ì€ íë¦„:
# PR merge
# GitHub Actionsì˜ CD workflow ì‹¤í–‰
# ë¹Œë“œ â†’ ì•„í‹°íŒ©íŠ¸ ìƒì„± â†’ Dev í™˜ê²½ ë°°í¬
# Dev ì„œë²„ì—ì„œ ìƒˆ ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
# ì´ ì‹œë‚˜ë¦¬ì˜¤ì˜ ì˜ë¯¸
# QA, ê°œë°œìëŠ” Dev í™˜ê²½ì—ì„œ ë°”ë¡œ ìµœì‹  ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥
# ê°œë°œì´ ë¹ ë¥´ê³  ì•ˆì •ì ìœ¼ë¡œ ìˆœí™˜
# ìš´ì˜/ë°°í¬ ê³¼ì • ìë™í™”ë¥¼ í†µí•´ â€œì‚¬ëŒì´ í•˜ëŠ” ì‹¤ìˆ˜â€ ì œê±°

# ğŸ“Œ 3. ì „ì²´ íë¦„ ì •ë¦¬ (í•œëˆˆì— ë³´ê¸°)
# Feature branch ìƒì„±
#         â†“
#     Commit(ì—¬ëŸ¬ ë²ˆ)
#         â†“ (trigger)
#         CI (ë¹Œë“œ/í…ŒìŠ¤íŠ¸)
#         â†“
# Pull Request ë³´ë‚´ê¸°
#         â†“ (trigger)
#         CI ì¬ê²€ì¦
#         â†“
# ë¦¬ë·°ì–´ ìŠ¹ì¸ â†’ Merge
#         â†“ (trigger)
# Dev ë¸Œëœì¹˜ ë°˜ì˜
#         â†“
# CD â†’ Dev í™˜ê²½ ìë™ ë°°í¬

# ğŸ¯ 4. ì´ ì „ëµì˜ ì¥ì 
# âœ” 1) ì•ˆì •ì ì¸ ë©”ì¸ ê°œë°œ ë¼ì¸ ìœ ì§€
# DevëŠ” í•­ìƒ "ë¬¸ì œ ì—†ëŠ” ìƒíƒœ"ë¡œ ìœ ì§€ë¨.
# âœ” 2) CIë¡œ í’ˆì§ˆ ìë™ ë³´ì¦
# ì‚¬ëŒì´ ë°œê²¬í•˜ê¸° ì „ì— í…ŒìŠ¤íŠ¸ì—ì„œ ê±¸ëŸ¬ì§.
# âœ” 3) PR ê¸°ë°˜ ì½”ë“œ ë¦¬ë·°ë¡œ í’ˆì§ˆ ì¦ê°€
# ì½”ë“œ í’ˆì§ˆ, ë³´ì•ˆ, êµ¬ì¡° ê°œì„ ì— ë„ì›€.
# âœ” 4) Dev í™˜ê²½ ìë™ ë°°í¬ë¡œ ê°œë°œì†ë„ ì¦ê°€
# ë³‘í•© â†’ Dev ë°°í¬ â†’ QA í…ŒìŠ¤íŠ¸
# ì „ì²´ ì£¼ê¸°ê°€ ë§¤ìš° ì§§ì•„ì§.
# âœ” 5) í˜‘ì—… í‘œì¤€í™”
# íŒ€ì› ëˆ„êµ¬ë‚˜ ë™ì¼í•œ ê°œë°œ-ë°°í¬ í”„ë¡œì„¸ìŠ¤ë¥¼ ë”°ë¥´ê²Œ ë¨.
# ğŸ“Œ 5. ìµœì¢… ìš”ì•½
# ì´ ì´ë¯¸ì§€ëŠ” ì•„ë˜ 3ê°€ì§€ ì „ëµì„ ê²°í•©í•œ í‘œì¤€ DevOps ê°œë°œ í”„ë¡œì„¸ìŠ¤ë¥¼ í‘œí˜„í•¨:

# ğŸ’¡ 1) Git ì „ëµ
# Feature Branch Workflow
# PR ê¸°ë°˜ Merge ë°©ì‹
# ğŸ’¡ 2) CI ì „ëµ
# ì»¤ë°‹/PR ì‹œ ìë™ ë¹Œë“œÂ·í…ŒìŠ¤íŠ¸ ì‹¤í–‰
# ë¬¸ì œë¥¼ ì‚¬ì „ì— ì°¨ë‹¨
# ğŸ’¡ 3) CD ì „ëµ
# Dev ë¸Œëœì¹˜ì— mergeë˜ëŠ” ìˆœê°„
# ìë™ìœ¼ë¡œ Dev ì„œë²„ì— ë°°í¬
# ì¦‰, â€œGithub Actions ê¸°ë°˜ìœ¼ë¡œ CICD ì‹œì‘í•˜ê¸°â€ì˜ ê°€ì¥ ì´ìƒì ì¸ ê¸°ë³¸ ì‹œë‚˜ë¦¬ì˜¤ì…ë‹ˆë‹¤.

# ### ì›Œí¬í”Œë¡œìš° êµ¬ì„±

# - íŠ¸ë¦¬ê±° êµ¬ì„±
#     - github event : pull request
#     - path filter : my-app
#     - branch filter : dev
#     - ê°œë°œ í™˜ê²½ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ” dev branch ì—ë§Œ
#     - my-appì´ë¼ëŠ” ë””ë ‰í† ë¦¬ê°€ ë³€ê²½ë  ë•Œ
#     - PRì´ ìƒì„± & ë™ê¸°í™” (CI), ë¨¸ì§€ë˜ë©´ (CD)
# - ì¡ êµ¬ì„±
#     - test
#         - cache action ì‚¬ìš©
#         - npm build
#     - image-build
#         - aws action
#         - aws ecr action
#         - docker
#     - deploy
#         - aws action
#         - kubectl action
#         - helm action
#         - slack action